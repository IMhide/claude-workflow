name: Performance Analysis on Issue Creation

on:
  issues:
    types: [opened]

permissions:
  contents: read      # Read external repos
  issues: write       # Post comments
  id-token: write     # Claude Code OAuth

jobs:
  analyze-performance:
    runs-on: ubuntu-latest
    # Only run if issue contains YAML frontmatter
    if: contains(github.event.issue.body, '---')
    timeout-minutes: 20

    steps:
      # Step 1: Checkout this repository (for potential scripts if needed)
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # Step 2: Parse YAML frontmatter to extract repository field
      - name: Parse YAML frontmatter
        id: parse-yaml
        run: |
          # Extract content between first --- and second ---
          ISSUE_BODY="${{ github.event.issue.body }}"

          # Parse YAML frontmatter
          YAML_CONTENT=$(echo "$ISSUE_BODY" | sed -n '/^---$/,/^---$/p' | sed '1d;$d')

          # Extract repository field
          REPOSITORY=$(echo "$YAML_CONTENT" | grep -E '^repository:' | sed 's/^repository:[[:space:]]*//' | tr -d '\r\n')

          # Validate format (owner/repo)
          if [[ ! "$REPOSITORY" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "::error::Invalid or missing repository field in YAML frontmatter"
            echo "::error::Expected format: repository: owner/repo"
            exit 1
          fi

          echo "repository=$REPOSITORY" >> $GITHUB_OUTPUT
          echo "Parsed repository: $REPOSITORY"

      # Step 3: Validate repository access
      - name: Validate repository access
        run: |
          REPO="${{ steps.parse-yaml.outputs.repository }}"
          echo "Validating access to $REPO..."

          # Check if repository exists and is accessible
          gh repo view "$REPO" --json name,owner > /dev/null 2>&1 || {
            echo "::error::Cannot access repository $REPO"
            echo "::error::Ensure repository exists and GH_PAT has access"
            exit 1
          }
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      # Step 4: Determine default branch
      - name: Get default branch
        id: get-branch
        run: |
          REPO="${{ steps.parse-yaml.outputs.repository }}"

          # Get default branch from GitHub API
          DEFAULT_BRANCH=$(gh repo view "$REPO" --json defaultBranchRef --jq '.defaultBranchRef.name')

          if [ -z "$DEFAULT_BRANCH" ]; then
            echo "::warning::Could not determine default branch, using 'main'"
            DEFAULT_BRANCH="main"
          fi

          echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "Default branch: $DEFAULT_BRANCH"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      # Step 5: Checkout target repository
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse-yaml.outputs.repository }}
          ref: ${{ steps.get-branch.outputs.branch }}
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          path: target-repo

      # Step 6: Run Claude Code Performance Analysis
      - name: Run Performance Analysis with Claude Code
        id: claude-analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          working_directory: target-repo
          prompt: |
            You are analyzing repository **${{ steps.parse-yaml.outputs.repository }}** to investigate and provide recommendations for specific performance issues reported in GitHub issue #${{ github.event.issue.number }}.

            ## Step 1: Read the Performance Issue Report

            First, read the issue body from: ${{ github.event.issue.html_url }}

            The issue contains a detailed performance report with:
            - YAML frontmatter with repository information
            - Performance metrics (response times, throughput, error rates)
            - Critical information about the affected endpoint/action
            - Sample traces showing where time is spent
            - Possible N+1 query detection
            - Resource allocation breakdown

            **Parse the issue to extract**:
            - Affected endpoint/action name
            - Performance metrics (mean/median/p90/p95 response times)
            - Identified bottlenecks (e.g., database queries, external API calls)
            - Sample trace information
            - Any N+1 queries or resource allocation issues

            ## Step 2: Analyze the Repository

            Based on the specific issues identified in the report:

            ### 2.1 Locate the Problematic Code
            - Find the endpoint/action mentioned in the report
            - Locate controller/handler code for that specific endpoint
            - Identify database queries, API calls, or operations mentioned in the trace
            - Find related models, services, or helpers

            ### 2.2 Identify Root Causes
            Focus on the specific performance issues reported:
            - If N+1 queries are mentioned: Find the exact queries and relationships
            - If slow database queries: Analyze the specific query patterns
            - If external API calls are slow: Identify the integration points
            - If memory allocation is high: Find object creation patterns in that path
            - If long response times: Trace the execution path to find bottlenecks

            ### 2.3 Verify Against Samples
            Cross-reference the code with the sample traces in the issue:
            - Match method names and durations from samples to code
            - Verify which components are taking the most time
            - Identify if the issue is consistent across samples

            ## Step 3: Generate Targeted Recommendations

            Provide specific, actionable recommendations to fix the exact issues reported:

            ### Root Cause Summary
            - Clearly state what is causing the performance problem
            - Reference specific files, lines, and code patterns
            - Explain why this causes the performance degradation

            ### Recommended Fixes (Prioritized)

            For each issue identified in the report, provide:

            #### Fix #1: [Descriptive Title]
            **Problem**: Describe the specific issue (e.g., "N+1 query loading user associations")
            **Location**: `path/to/file.rb:123-145`
            **Current Impact**: [e.g., "Causing 50+ extra database queries per request"]

            **Recommended Solution**:
            Explain the fix approach (e.g., "Add eager loading with includes/preload")

            **Implementation**:
            ```language
            # CURRENT CODE (causing N+1)
            # Show the exact problematic code from the repository

            # RECOMMENDED FIX
            # Show the specific code change needed
            ```

            **Expected Improvement**: [e.g., "Reduce queries from 52 to 2, ~200ms faster"]
            **Effort**: [Low/Medium/High]

            #### Fix #2: [Next Most Important Fix]
            [Same structure as above]

            ### Additional Optimizations
            - Quick wins that complement the main fixes
            - Configuration changes (indexes, caching)
            - Monitoring recommendations

            ### Implementation Priority
            1. **Critical** - Fix immediately (highest impact on reported issue)
            2. **High** - Fix soon (addresses reported problem)
            3. **Medium** - Valuable improvements
            4. **Low** - Nice-to-have optimizations

            ### Testing Recommendations
            - How to verify the fixes work
            - Metrics to monitor before/after
            - Performance benchmarks to run

            ## Output Requirements

            - Be specific to the issues in the GitHub issue report
            - Reference exact files, line numbers, and code patterns found
            - Provide complete, copy-pasteable code fixes
            - Explain the reasoning behind each recommendation
            - Prioritize fixes by impact on the reported performance issue
            - Format as clear markdown suitable for a GitHub comment

            Start by reading the issue, then analyze the codebase for those specific problems.

            ## CRITICAL: Write Output to File

            After completing your analysis, you MUST write your complete markdown report to a file.

            **Instructions**:
            1. Write the entire analysis report to a file named `analysis-output.md` in the current working directory
            2. The file should contain ONLY the markdown report (no extra text)
            3. Ensure the file is written even if you encountered partial issues during analysis
            4. Format: Complete markdown suitable for posting as a GitHub comment
            5. If you cannot complete the full analysis, write whatever findings you have with a note about limitations

            **File path**: `analysis-output.md` (relative to working directory)

            After writing the file, confirm it was created successfully.
          claude_args: "--model claude-sonnet-4-20250514 --permission-mode bypassPermissions"

      # Step 6.5: Verify output file creation
      - name: Verify Claude Code output
        if: always()
        run: |
          echo "=== Checking for Claude Code output ==="
          echo "Working directory contents:"
          ls -la .

          OUTPUT_FILE="./analysis-output.md"
          if [ -f "$OUTPUT_FILE" ]; then
            echo "✅ Output file exists"
            echo "File size: $(wc -c < "$OUTPUT_FILE") bytes"
            echo "First 10 lines:"
            head -n 10 "$OUTPUT_FILE"
          else
            echo "❌ Output file not found at: $OUTPUT_FILE"
            echo "Searching for analysis-output.md files:"
            find . -name "analysis-output.md" -type f 2>/dev/null || echo "No analysis-output.md files found"
          fi

      # Step 7: Post analysis results as comment
      - name: Post analysis results as comment
        if: success()
        run: |
          # Define the output file path
          OUTPUT_FILE="./analysis-output.md"

          # Check if Claude Code created the output file
          if [ -f "$OUTPUT_FILE" ]; then
            echo "✅ Analysis output file found"

            # Create comment with template header
            cat > comment.md << 'COMMENT_EOF'
          ## :mag: Performance Analysis Results

          Analysis completed for repository **${{ steps.parse-yaml.outputs.repository }}**

          ---

          COMMENT_EOF

            # Append the analysis content
            cat "$OUTPUT_FILE" >> comment.md

            # Append template footer
            cat >> comment.md << 'FOOTER_EOF'

          ---

          <sub>:robot: Analyzed by Claude Code • Triggered by issue creation • [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          FOOTER_EOF

            # Post the comment
            gh issue comment ${{ github.event.issue.number }} \
              --body-file comment.md \
              --repo ${{ github.repository }}

            echo "✅ Comment posted successfully"
          else
            echo "❌ Analysis output file not found at: $OUTPUT_FILE"
            echo "Available files in target-repo:"
            ls -la target-repo/ || true

            # Post error comment
            cat > error-comment.md << 'ERROR_EOF'
          ## :warning: Analysis Output Not Found

          The Claude Code analysis completed, but the output file was not created.

          **Expected file**: `analysis-output.md`
          **Repository**: `${{ steps.parse-yaml.outputs.repository }}`

          This may indicate:
          - Claude Code encountered an error during analysis
          - The output file wasn't written to the expected location
          - There was an issue with file permissions

          Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          ERROR_EOF

            gh issue comment ${{ github.event.issue.number }} \
              --body-file error-comment.md \
              --repo ${{ github.repository }}

            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 8: Handle analysis failure
      - name: Handle analysis failure
        if: failure()
        run: |
          echo "=== Failure Debugging ==="
          echo "Checking for partial output file..."

          OUTPUT_FILE="./analysis-output.md"

          # Check if partial output exists
          if [ -f "$OUTPUT_FILE" ]; then
            echo "⚠️  Partial output file found, including in error comment"

            cat > error-comment.md << 'EOF'
          ## :warning: Performance Analysis Partially Completed

          The analysis encountered an error but produced partial results:

          ---

          EOF
            cat "$OUTPUT_FILE" >> error-comment.md

            cat >> error-comment.md << 'EOF'

          ---

          **Repository**: `${{ steps.parse-yaml.outputs.repository }}`
          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please review the workflow logs for error details.
          EOF
          else
            cat > error-comment.md << 'EOF'
          ## :warning: Performance Analysis Failed

          The automatic performance analysis encountered an error.

          **Repository**: `${{ steps.parse-yaml.outputs.repository }}`
          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Troubleshooting

          Please verify:
          1. YAML frontmatter format is correct:
             ```yaml
             ---
             repository: owner/repo
             ---
             ```
          2. Repository exists and is accessible
          3. Repository contains analyzable code
          4. Issue contains valid performance data

          Check the workflow logs for detailed error information.
          EOF
          fi

          gh issue comment ${{ github.event.issue.number }} \
            --body-file error-comment.md \
            --repo ${{ github.repository }} || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 9: Debug information
      - name: Debug information
        if: always()
        run: |
          echo "=== Debug Information ==="
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Repository: ${{ steps.parse-yaml.outputs.repository }}"
          echo "Issue Author: ${{ github.event.issue.user.login }}"
          echo "Workflow Status: ${{ job.status }}"
