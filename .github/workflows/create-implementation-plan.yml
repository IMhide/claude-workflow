name: Create Implementation Plan

on:
  issues:
    types: [labeled]

permissions:
  contents: read      # Read external repos
  issues: write       # Post comments
  id-token: write     # Claude Code OAuth

jobs:
  create-implementation-plan:
    runs-on: ubuntu-latest
    # Only run if ready-to-plan label is added AND issue contains YAML frontmatter
    if: |
      github.event.label.name == 'ready-to-plan' &&
      contains(github.event.issue.body, '---')
    timeout-minutes: 25

    steps:
      # Step 1: Checkout this repository (for system prompt file)
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # Step 2: Parse YAML frontmatter to extract repository field
      - name: Parse YAML frontmatter
        id: parse-yaml
        run: |
          # Extract content between first --- and second ---
          ISSUE_BODY="${{ github.event.issue.body }}"

          # Parse YAML frontmatter
          YAML_CONTENT=$(echo "$ISSUE_BODY" | sed -n '/^---$/,/^---$/p' | sed '1d;$d')

          # Extract repository field
          REPOSITORY=$(echo "$YAML_CONTENT" | grep -E '^repository:' | sed 's/^repository:[[:space:]]*//' | tr -d '\r\n')

          # Validate format (owner/repo)
          if [[ ! "$REPOSITORY" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "::error::Invalid or missing repository field in YAML frontmatter"
            echo "::error::Expected format: repository: owner/repo"
            exit 1
          fi

          echo "repository=$REPOSITORY" >> $GITHUB_OUTPUT
          echo "Parsed repository: $REPOSITORY"

      # Step 3: Validate repository access
      - name: Validate repository access
        run: |
          REPO="${{ steps.parse-yaml.outputs.repository }}"
          echo "Validating access to $REPO..."

          # Check if repository exists and is accessible
          gh repo view "$REPO" --json name,owner > /dev/null 2>&1 || {
            echo "::error::Cannot access repository $REPO"
            echo "::error::Ensure repository exists and GH_PAT has access"
            exit 1
          }
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      # Step 4: Determine default branch
      - name: Get default branch
        id: get-branch
        run: |
          REPO="${{ steps.parse-yaml.outputs.repository }}"

          # Get default branch from GitHub API
          DEFAULT_BRANCH=$(gh repo view "$REPO" --json defaultBranchRef --jq '.defaultBranchRef.name')

          if [ -z "$DEFAULT_BRANCH" ]; then
            echo "::warning::Could not determine default branch, using 'main'"
            DEFAULT_BRANCH="main"
          fi

          echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "Default branch: $DEFAULT_BRANCH"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      # Step 5: Fetch ALL issue comments
      - name: Fetch issue comments
        id: fetch-comments
        run: |
          echo "Fetching comments for issue #${{ github.event.issue.number }}..."

          # Get comment count first
          COMMENT_COUNT=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments --jq 'length')

          echo "Found $COMMENT_COUNT comment(s)"
          echo "comment_count=$COMMENT_COUNT" >> $GITHUB_OUTPUT

          if [ "$COMMENT_COUNT" -gt 0 ]; then
            # Fetch all comments and format as markdown
            gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
              --paginate \
              --jq '.[] | "### Comment by @\(.user.login)\n**Posted:** \(.created_at | sub("T"; " ") | sub("Z"; " UTC"))\n\n\(.body)\n\n---\n"' \
              > /tmp/issue-comments.md

            echo "Comments saved to /tmp/issue-comments.md"

            # Show preview (first 20 lines)
            echo "Preview of comments:"
            head -n 20 /tmp/issue-comments.md

            # Check if comments are very large
            COMMENT_SIZE=$(wc -c < /tmp/issue-comments.md)
            if [ "$COMMENT_SIZE" -gt 100000 ]; then
              echo "::warning::Comment thread is very large ($COMMENT_SIZE bytes). Consider reviewing for relevance."
            fi
          else
            echo "No comments found. Creating empty comments file."
            echo "# No Comments\n\nThis issue has no comments yet." > /tmp/issue-comments.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 6: Checkout target repository
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse-yaml.outputs.repository }}
          ref: ${{ steps.get-branch.outputs.branch }}
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          path: target-repo

      # Step 7: Prepare system prompt
      - name: Prepare system prompt
        run: |
          # Copy system prompt to /tmp so Claude Code can access it
          cp .github/prompts/implementation-plan-system.md /tmp/system-prompt.txt
          echo "System prompt prepared at /tmp/system-prompt.txt"

      # Step 8: Run Claude Code Implementation Planning
      - name: Run Implementation Planning with Claude Code
        id: claude-planning
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          working_directory: target-repo
          system_prompt_file: /tmp/system-prompt.txt
          prompt: |
            Create an implementation plan for the feature request in GitHub issue #${{ github.event.issue.number }}.

            **Issue URL**: ${{ github.event.issue.html_url }}
            **Repository**: ${{ steps.parse-yaml.outputs.repository }}
            **Comment Count**: ${{ steps.fetch-comments.outputs.comment_count }}

            ## Your Task

            1. Read the issue body to understand the feature request
            2. Read ALL issue comments from `/tmp/issue-comments.md` to capture:
               - Clarifications and questions
               - Design decisions made in discussion
               - User feedback and requirements refinement
               - Technical constraints mentioned
            3. Analyze the codebase to:
               - Find similar features (patterns to follow)
               - Identify files that need modification
               - Understand current architecture
               - Locate relevant tests
            4. Create a comprehensive implementation plan

            Write your complete plan to `implementation-plan.md` in the current working directory.
          claude_args: "--model claude-sonnet-4-20250514 --permission-mode bypassPermissions"

      # Step 9: Verify output file creation
      - name: Verify Claude Code output
        if: always()
        run: |
          echo "=== Checking for Claude Code output ==="
          echo "Working directory contents:"
          ls -la .

          OUTPUT_FILE="./implementation-plan.md"
          if [ -f "$OUTPUT_FILE" ]; then
            echo "âœ… Output file exists"
            echo "File size: $(wc -c < "$OUTPUT_FILE") bytes"
            echo "First 15 lines:"
            head -n 15 "$OUTPUT_FILE"
          else
            echo "âŒ Output file not found at: $OUTPUT_FILE"
            echo "Searching for implementation-plan.md files:"
            find . -name "implementation-plan.md" -type f 2>/dev/null || echo "No implementation-plan.md files found"
          fi

      # Step 10: Post implementation plan as comment
      - name: Post implementation plan as comment
        if: success()
        run: |
          OUTPUT_FILE="./implementation-plan.md"

          # Check if Claude Code created the output file
          if [ -f "$OUTPUT_FILE" ]; then
            echo "âœ… Implementation plan found"

            # Create comment with template header
            cat > comment.md << 'COMMENT_EOF'
          ## ðŸ“‹ Implementation Plan

          Implementation plan created for repository **${{ steps.parse-yaml.outputs.repository }}**

          **Issue**: #${{ github.event.issue.number }}
          **Comments analyzed**: ${{ steps.fetch-comments.outputs.comment_count }}

          ---

          COMMENT_EOF

            # Append the plan content
            cat "$OUTPUT_FILE" >> comment.md

            # Append template footer
            cat >> comment.md << 'FOOTER_EOF'

          ---

          <sub>ðŸ¤– Generated by Claude Code â€¢ Triggered by `ready-to-plan` label â€¢ [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          FOOTER_EOF

            # Post the comment
            gh issue comment ${{ github.event.issue.number }} \
              --body-file comment.md \
              --repo ${{ github.repository }}

            echo "âœ… Comment posted successfully"
          else
            echo "âŒ Implementation plan file not found at: $OUTPUT_FILE"

            # Post error comment
            cat > error-comment.md << 'ERROR_EOF'
          ## âš ï¸ Implementation Plan Not Generated

          The Claude Code planning process completed, but the output file was not created.

          **Expected file**: `implementation-plan.md`
          **Repository**: `${{ steps.parse-yaml.outputs.repository }}`

          This may indicate:
          - Claude Code encountered an error during analysis
          - The output file wasn't written to the expected location
          - The codebase structure prevented proper analysis

          Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          ERROR_EOF

            gh issue comment ${{ github.event.issue.number }} \
              --body-file error-comment.md \
              --repo ${{ github.repository }}

            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 11: Handle planning failure
      - name: Handle planning failure
        if: failure()
        run: |
          echo "=== Failure Debugging ==="
          echo "Checking for partial output file..."

          OUTPUT_FILE="./implementation-plan.md"

          # Check if partial output exists
          if [ -f "$OUTPUT_FILE" ]; then
            echo "âš ï¸  Partial output file found, including in error comment"

            cat > error-comment.md << 'EOF'
          ## âš ï¸ Implementation Planning Partially Completed

          The planning process encountered an error but produced partial results:

          ---

          EOF
            cat "$OUTPUT_FILE" >> error-comment.md

            cat >> error-comment.md << 'EOF'

          ---

          **Repository**: `${{ steps.parse-yaml.outputs.repository }}`
          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please review the workflow logs for error details and consider the partial plan above.
          EOF
          else
            cat > error-comment.md << 'EOF'
          ## âš ï¸ Implementation Planning Failed

          The automatic implementation planning encountered an error.

          **Repository**: `${{ steps.parse-yaml.outputs.repository }}`
          **Issue**: #${{ github.event.issue.number }}
          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Troubleshooting

          Please verify:
          1. YAML frontmatter format is correct:
             ```yaml
             ---
             repository: owner/repo
             ---
             ```
          2. Repository exists and is accessible
          3. Issue description provides sufficient context
          4. Comments have been analyzed (${{ steps.fetch-comments.outputs.comment_count }} found)

          Check the workflow logs for detailed error information.
          EOF
          fi

          gh issue comment ${{ github.event.issue.number }} \
            --body-file error-comment.md \
            --repo ${{ github.repository }} || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 12: Debug information
      - name: Debug information
        if: always()
        run: |
          echo "=== Debug Information ==="
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Repository: ${{ steps.parse-yaml.outputs.repository }}"
          echo "Issue Author: ${{ github.event.issue.user.login }}"
          echo "Label Added: ${{ github.event.label.name }}"
          echo "Comment Count: ${{ steps.fetch-comments.outputs.comment_count }}"
          echo "Workflow Status: ${{ job.status }}"
