name: Performance Analysis on Issue Creation (Optimized)

on:
  issues:
    types: [opened]

permissions:
  contents: read      # Read external repos
  issues: write       # Post comments
  id-token: write     # Claude Code OAuth

jobs:
  analyze-performance:
    runs-on: ubuntu-latest
    # Only run if issue contains YAML frontmatter
    if: contains(github.event.issue.body, '---')
    timeout-minutes: 20

    steps:
      # Step 1: Checkout this repository (for system prompt file)
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # Step 2: Parse YAML frontmatter to extract repository field
      - name: Parse YAML frontmatter
        id: parse-yaml
        run: |
          # Extract content between first --- and second ---
          ISSUE_BODY="${{ github.event.issue.body }}"

          # Parse YAML frontmatter
          YAML_CONTENT=$(echo "$ISSUE_BODY" | sed -n '/^---$/,/^---$/p' | sed '1d;$d')

          # Extract repository field
          REPOSITORY=$(echo "$YAML_CONTENT" | grep -E '^repository:' | sed 's/^repository:[[:space:]]*//' | tr -d '\r\n')

          # Validate format (owner/repo)
          if [[ ! "$REPOSITORY" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "::error::Invalid or missing repository field in YAML frontmatter"
            echo "::error::Expected format: repository: owner/repo"
            exit 1
          fi

          echo "repository=$REPOSITORY" >> $GITHUB_OUTPUT
          echo "Parsed repository: $REPOSITORY"

      # Step 3: Validate repository access
      - name: Validate repository access
        run: |
          REPO="${{ steps.parse-yaml.outputs.repository }}"
          echo "Validating access to $REPO..."

          # Check if repository exists and is accessible
          gh repo view "$REPO" --json name,owner > /dev/null 2>&1 || {
            echo "::error::Cannot access repository $REPO"
            echo "::error::Ensure repository exists and GH_PAT has access"
            exit 1
          }
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      # Step 4: Determine default branch
      - name: Get default branch
        id: get-branch
        run: |
          REPO="${{ steps.parse-yaml.outputs.repository }}"

          # Get default branch from GitHub API
          DEFAULT_BRANCH=$(gh repo view "$REPO" --json defaultBranchRef --jq '.defaultBranchRef.name')

          if [ -z "$DEFAULT_BRANCH" ]; then
            echo "::warning::Could not determine default branch, using 'main'"
            DEFAULT_BRANCH="main"
          fi

          echo "branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT
          echo "Default branch: $DEFAULT_BRANCH"
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      # Step 5: Checkout target repository
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse-yaml.outputs.repository }}
          ref: ${{ steps.get-branch.outputs.branch }}
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          path: target-repo

      # Step 6: Prepare system prompt
      - name: Prepare system prompt
        run: |
          # Copy system prompt to /tmp so Claude Code can access it
          cp .github/prompts/rails-codebase-analysis-system.md /tmp/system-prompt.txt
          echo "System prompt prepared at /tmp/system-prompt.txt"

      # Step 7: Run Claude Code Performance Analysis
      - name: Run Performance Analysis with Claude Code
        id: claude-analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          working_directory: target-repo
          system_prompt_file: /tmp/system-prompt.txt
          prompt: |
            Analyze the Rails performance issue reported in GitHub issue #${{ github.event.issue.number }}.

            **Issue URL**: ${{ github.event.issue.html_url }}
            **Repository**: ${{ steps.parse-yaml.outputs.repository }}

            Read the issue to understand the performance problem, analyze the codebase to find the root cause, and provide actionable recommendations.

            Write your complete analysis to `analysis-output.md` in the current working directory.
          claude_args: "--model claude-sonnet-4-20250514 --permission-mode bypassPermissions"

      # Step 8: Verify output file creation
      - name: Verify Claude Code output
        if: always()
        run: |
          echo "=== Checking for Claude Code output ==="
          echo "Working directory contents:"
          ls -la .

          OUTPUT_FILE="./analysis-output.md"
          if [ -f "$OUTPUT_FILE" ]; then
            echo "✅ Output file exists"
            echo "File size: $(wc -c < "$OUTPUT_FILE") bytes"
            echo "First 10 lines:"
            head -n 10 "$OUTPUT_FILE"
          else
            echo "❌ Output file not found at: $OUTPUT_FILE"
            echo "Searching for analysis-output.md files:"
            find . -name "analysis-output.md" -type f 2>/dev/null || echo "No analysis-output.md files found"
          fi

      # Step 9: Post analysis results as comment
      - name: Post analysis results as comment
        if: success()
        run: |
          # Define the output file path
          OUTPUT_FILE="./analysis-output.md"

          # Check if Claude Code created the output file
          if [ -f "$OUTPUT_FILE" ]; then
            echo "✅ Analysis output file found"

            # Create comment with template header
            cat > comment.md << 'COMMENT_EOF'
          ## :mag: Performance Analysis Results

          Analysis completed for repository **${{ steps.parse-yaml.outputs.repository }}**

          ---

          COMMENT_EOF

            # Append the analysis content
            cat "$OUTPUT_FILE" >> comment.md

            # Append template footer
            cat >> comment.md << 'FOOTER_EOF'

          ---

          <sub>:robot: Analyzed by Claude Code (Optimized) • Triggered by issue creation • [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          FOOTER_EOF

            # Post the comment
            gh issue comment ${{ github.event.issue.number }} \
              --body-file comment.md \
              --repo ${{ github.repository }}

            echo "✅ Comment posted successfully"
          else
            echo "❌ Analysis output file not found at: $OUTPUT_FILE"
            echo "Available files in target-repo:"
            ls -la target-repo/ || true

            # Post error comment
            cat > error-comment.md << 'ERROR_EOF'
          ## :warning: Analysis Output Not Found

          The Claude Code analysis completed, but the output file was not created.

          **Expected file**: `analysis-output.md`
          **Repository**: `${{ steps.parse-yaml.outputs.repository }}`

          This may indicate:
          - Claude Code encountered an error during analysis
          - The output file wasn't written to the expected location
          - There was an issue with file permissions

          Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          ERROR_EOF

            gh issue comment ${{ github.event.issue.number }} \
              --body-file error-comment.md \
              --repo ${{ github.repository }}

            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 10: Handle analysis failure
      - name: Handle analysis failure
        if: failure()
        run: |
          echo "=== Failure Debugging ==="
          echo "Checking for partial output file..."

          OUTPUT_FILE="./analysis-output.md"

          # Check if partial output exists
          if [ -f "$OUTPUT_FILE" ]; then
            echo "⚠️  Partial output file found, including in error comment"

            cat > error-comment.md << 'EOF'
          ## :warning: Performance Analysis Partially Completed

          The analysis encountered an error but produced partial results:

          ---

          EOF
            cat "$OUTPUT_FILE" >> error-comment.md

            cat >> error-comment.md << 'EOF'

          ---

          **Repository**: `${{ steps.parse-yaml.outputs.repository }}`
          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please review the workflow logs for error details.
          EOF
          else
            cat > error-comment.md << 'EOF'
          ## :warning: Performance Analysis Failed

          The automatic performance analysis encountered an error.

          **Repository**: `${{ steps.parse-yaml.outputs.repository }}`
          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### Troubleshooting

          Please verify:
          1. YAML frontmatter format is correct:
             ```yaml
             ---
             repository: owner/repo
             ---
             ```
          2. Repository exists and is accessible
          3. Repository contains analyzable code
          4. Issue contains valid performance data

          Check the workflow logs for detailed error information.
          EOF
          fi

          gh issue comment ${{ github.event.issue.number }} \
            --body-file error-comment.md \
            --repo ${{ github.repository }} || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 11: Debug information
      - name: Debug information
        if: always()
        run: |
          echo "=== Debug Information ==="
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Repository: ${{ steps.parse-yaml.outputs.repository }}"
          echo "Issue Author: ${{ github.event.issue.user.login }}"
          echo "Workflow Status: ${{ job.status }}"
